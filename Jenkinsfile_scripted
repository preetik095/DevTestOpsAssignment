node {
    try {
        // Define tools
        tools {
            maven 'Maven'
        }

        stage('Checkout') {
            echo 'Cloning the git repository'
            checkout scm
        }

        stage('Build') {
            echo 'Building the code'
            bat "mvn clean install"
        }

        stage('Test') {
            echo 'Running tests'
            bat "mvn test"
        }

        stage('SonarQube Analysis') {
            withSonarQubeEnv('SonarQube_nagp') {
                echo 'Starting SonarQube analysis'
                bat "mvn sonar:sonar"
            }
        }

        // Uncomment and correct the Quality Gate stage if needed
        /*
        stage('Quality Gate') {
            echo 'Checking quality gate'
            timeout(time: 10, unit: 'MINUTES') {
                script {
                    try {
                        def qualityGate = waitForQualityGate()
                        if (qualityGate.status != 'OK') {
                            error "Pipeline failed due to SonarQube Quality Gate failure: ${qualityGate.status}"
                        }
                    } catch (Exception e) {
                        error "Error checking SonarQube Quality Gate: ${e.message}"
                    }
                }
            }
        }
        */

        stage('Publish Artifacts to Artifactory') {
            echo 'Uploading artifacts to Artifactory'
            rtMavenDeployer(
                id: 'deployer',
                serverId: '3181417@artifactory',
                releaseRepo: 'nagp.devtestops.assignment',
                snapshotRepo: 'nagp.devtestops.assignment'
            )
            rtMavenRun(
                pom: 'pom.xml',
                goals: 'clean install',
                deployerId: 'deployer'
            )
            rtPublishBuildInfo(
                serverId: '3181417@artifactory'
            )
        }

    } catch (Exception e) {
        echo "Build failed: ${e.message}"
        currentBuild.result = 'FAILURE' // Mark the build as failed
    } finally {
        echo 'Generating test results'
        junit '**/target/surefire-reports/*.xml'

        echo 'Build completed!'
    }

    post {
        always {
            echo 'Post-build actions completed.'
        }
        success {
            echo 'Build and SonarQube quality gate passed. Artifacts uploaded to Artifactory.'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
